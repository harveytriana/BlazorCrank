@page "/fetchdata"
@using System.Text

<h1>Native Dependencies Callbacks</h1>
<hr />
<pre>
@echo
</pre>

<p @onclick="Test">Test</p>

@code {
    // CALLBACK
    delegate void CppCallback(int number);
    [DllImport("CallbackSample")]
    static extern void UnmanagedPrompt(CppCallback cppCallback);

    string echo = "Ready.";

    async Task Test()
    {
        Echo("Try Callbacks");
        Echo("Assertion at /__w/1/s/src/mono/mono/metadata/loader.c:1806, condition `<disabled>' not met");


        await Task.Delay(2000);
        try {
            UnmanagedPrompt(HandlePrompt);
        }catch(Exception e) {
            Echo(e.Message);
        }

    }

    private void HandlePrompt(int number)
    {
        Echo($"Called back by unmanaged side. Number: {number}");
    }

    void Echo(string? message = null)
    {
        if (message is null) {
            echo = string.Empty;
        }
        else {
            var sb = new StringBuilder();
            sb.Append(echo);
            sb.Append(message);
            sb.Append("\n");
            echo = sb.ToString();
            StateHasChanged();
        }
    }
}